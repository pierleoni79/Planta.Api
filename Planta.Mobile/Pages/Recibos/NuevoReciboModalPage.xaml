<?xml version="1.0" encoding="utf-8" ?>
<!-- Ruta: /Planta.Mobile/Pages/Recibos/NuevoReciboModalPage.xaml | V1.7.2-fix (toolkit:EventToCommandBehavior) -->
<ContentPage
    x:Class="Planta.Mobile.Pages.Recibos.NuevoReciboModalPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:Planta.Mobile.ViewModels.Recibos"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    x:DataType="vm:NuevoReciboVM"
    Title="Nuevo Recibo">

    <!-- Dispara carga de favoritos cuando la pÃ¡gina aparece -->
    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior
            EventName="Appearing"
            Command="{Binding CargarFavoritosCommand}" />
    </ContentPage.Behaviors>

    <Grid RowDefinitions="Auto,Auto,*,Auto" ColumnDefinitions="*" Padding="16" RowSpacing="12">

        <!-- Banner favoritos (chips) -->
        <CollectionView Grid.Row="0"
                        ItemsSource="{Binding Favoritos}"
                        HorizontalScrollBarVisibility="Never">
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="6" />
            </CollectionView.ItemsLayout>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:VehiculoFavoritoVM">
                    <Border Padding="8" StrokeThickness="1" Stroke="#DDD" Background="#FFF">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="12" />
                        </Border.StrokeShape>
                        <Grid ColumnDefinitions="Auto,Auto,Auto" ColumnSpacing="6">
                            <Label Text="{Binding Placa}" FontAttributes="Bold"/>
                            <Label Grid.Column="1" Text="{Binding ConductorNombre}" LineBreakMode="TailTruncation" />
                            <Label Grid.Column="2" Text="{Binding Estrella}" />
                        </Grid>
                        <Border.GestureRecognizers>
                            <!-- âœ… Usa el comando del item -->
                            <TapGestureRecognizer
                                Command="{Binding SeleccionarFavoritoCommand}"
                                CommandParameter="{Binding .}" />
                        </Border.GestureRecognizers>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Placa + Resolver -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="8">
            <Entry Placeholder="PLACA" Text="{Binding Placa}" />
            <Button Grid.Column="1" Text="Resolver" Command="{Binding ResolverPlacaCommand}" />
        </Grid>

        <!-- Form principal -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Spacing="10">
                <Label Text="{Binding PlacaInfo}" FontAttributes="Italic" />

                <Picker Title="Destino" SelectedIndex="{Binding DestinoIndex}">
                    <Picker.Items>
                        <x:String>Planta</x:String>
                        <x:String>Cliente</x:String>
                    </Picker.Items>
                </Picker>

                <Entry Placeholder="ClienteId (si aplica)" Keyboard="Numeric"
                       IsVisible="{Binding EsDestinoCliente}"
                       Text="{Binding ClienteId}" />
                <Entry Placeholder="PlantaId (si aplica)" Keyboard="Numeric"
                       IsVisible="{Binding EsDestinoPlanta}"
                       Text="{Binding PlantaId}" />

                <Entry Placeholder="MaterialId" Keyboard="Numeric" Text="{Binding MaterialId}" />

                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                    <Entry Placeholder="Unidad (m3/ton)"
                           Text="{Binding Unidad}"
                           IsEnabled="{Binding UnidadHabilitada}" />
                    <Entry Grid.Column="1" Placeholder="Cantidad" Keyboard="Numeric" Text="{Binding Cantidad}" />
                </Grid>

                <Button Text="Calcular Tarifa" Command="{Binding CalcularTarifaCommand}" />
                <Label Text="{Binding TarifaInfo}" />
            </VerticalStackLayout>
        </ScrollView>

        <Grid Grid.Row="3" ColumnDefinitions="*,Auto" ColumnSpacing="8">
            <Button Text="Crear" Command="{Binding CrearCommand}" />
            <Button Grid.Column="1" Text="Cerrar" Command="{Binding CerrarCommand}" />
        </Grid>
    </Grid>
</ContentPage>
